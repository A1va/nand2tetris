# [计算机体系结构 Computer Architecture]

本章涵盖“硬件”部分中最难啃的内容。将第1~3章构建的所有芯片整合并集成一台通用计算机Hack。

Hack优点：

1. 通过前面构建的芯片可以几小时构建完成。
2. Hack计算机的体系结构足以描述任何数字计算机的关键操作原理和硬件组成。

**This chapter is more Complicated than last.**

### [背景知识]

#### 1. 存储程序概念

​		一个由有限硬件组件构成的计算机却可以执行无限的任务队列，其实都是**“存储程序(stored program)”**概念的硕果。计算机基于固定的硬件平台，能够执行固定的指令集。同时，这些指令能够被当成构建模块，组成任意的程序。而且，这些程序的逻辑被存储到计算机的**存储设备(memory)**里，跟数据一样，成为所谓的**“软件(software)”**。



#### 2.冯·诺伊曼结构

​		存储系统概念最著名的是**通用图灵机(1936)**和**冯·诺伊曼机(1945)**。

​		图灵机描述虚拟的简单计算机的抽象机，主要用来分分析计算机的逻辑结构。相比之下，冯·诺伊曼机是实际应用型的体系结构，是今天所有计算机结构的基础。

![冯·诺伊曼机](C5-计算机体系结构.assets/image-20200830133841248.png)

​		冯·诺伊曼体系结构的基础是一个**中央处理单元(CPU, Central Processing Unit)**，它与**记忆设备(memory device)**即**广义的内存**进行交互，负责从**输入设备(input device)**接收数据，向**输出设备(output device)**发送数据。体系结构的核心是存储程序的概念：计算机内存不仅存储着要进行操作的数据，还存储着指示计算机运行的指令。

​		广义的内存代表任何具有存储功能的设备和组件。

![DataBus、AddressBus、ControlBus](C5-计算机体系结构.assets/image-20200901111929066.png)

​		Data、Address、Control这三部分的每一段信息都由电线实现，通过一组公共总线。公共电线分别有数据总线、地址总线、控制总线。

​		首先是数据总线和`ALU`的交互，输入数据进行算术运算或逻辑运算，得出结果再输出到数据总线，然后到**内存(memory)**或**寄存器(registers)**。

​		控制总线。`ALU`需要知道它每次运行的是什么操作，所以它必须从控制总线中重新获取信息，指定它所要进行的操作类型。通过条件分支或循环条件决定下一个指令是什么？这种控制通过控制位(sel)实现, 所以我们需要从`ALU`中获取控制信息反馈到控制系统的其他部分。



|   ————   |                          CPU中的ALU                          |         CPU中的Registers         |        内存Memory        |
| :------: | :----------------------------------------------------------: | :------------------------------: | :----------------------: |
| 数据总线 | 往`ALU`输入数据进行算术运算 / 逻辑运算，`ALU`输出运算结果，再反馈到其它 |               读写               |           读写           |
| 地址总线 |                             ————                             | 间接寻址到RAM或者跳到一个ROM地址 |       下图一和图二       |
| 控制总线 | 往`ALU`输入控制位(sel)决定`ALU`将要进行的运算操作类型；通过条件分支或循环条件决定下一个指令，获取控制信息反馈到控制系统的其他部分。 |     反馈到控制系统的其他部分     | 反馈到控制系统的其他部分 |

![dataMemory](C5-计算机体系结构.assets/image-20200901145605717.png)

​		根据地址得到需要操作的数据块，并对其进行读写操作。

![programMemory](C5-计算机体系结构.assets/image-20200901145738663.png)

​		需要将下一个程序指令的地址输入到**程序内存**，因为这是我们使用程序指令的地方，放置地址后，从那里得到指令，也可能是数字。程序内存中的指令告诉系统的其他部分该做什么，所以我们需要从下一个指令中获取信息，也即从程序内存的数据输出，并将其输入到控制总线。



#### 3. 内存

​		冯·诺伊曼机的内存中存有两种类型的信息：**数据项(data items)** 和 **程序指令(programing instructioins)**。采用不同方式处理两种信息，并被分别存储到不同的内存区，尽管功能不同，但都以二进制数形式存储在具有通用结构的**随机存取器(RAM)**。一个单独的字（一个数据项或者一条指令）通过它的地址指定。

- 数据内存        高级程序操纵的抽象组件，例如变量、数组和对象。这些数据抽象被翻译成机器语言后，变成一连串的二进制数，存储在数据内存。通过指定的地址进行读写操作。
- 指令内存        高级指令 如上类似处理，并被存储在指令内存。计算机每一步操作，CPU从指令中取出一个字，对其进行解码，从而执行指定的指令，然后计算下一条将要执行的指令。
  - 指令内存中的指令格式遵守机器语言的规则。



#### 4. 中央处理器

​		CPU是计算机体系的核心，负责执行已被加载到指令内存的指令。CPU通过使用三个主要的硬件执行指令：**算术逻辑单元(ALU, Arithmetic-Logic Unit)**，一组**寄存器(registers)**和**控制单元(control unit)**。

- **算术逻辑单元（ALU）**		ALU 负责执行计算机中所有底层的算术操作和逻辑操作。
- **寄存器（Registers）**          CPU 的设计是为了能够快速地执行简单计算。与运算相关的数据暂存到高速寄存器，远比从内存搬进搬出快得多。
- **控制单元（Control Unit）** 计算机指令用二进制数表示，通常具有16、32或64位宽。在指令可被执行之前，要对其进行解码，指令包含的信息向不同的硬件（ALU，寄存器，内存）发送信号，指使它们如何执行指令。指令解码过程是通过某些**控制单元**完成的。这些控制单元还负责决定下一条读取和执行哪一条指令。



#### 5. 寄存器

​		内存访问是很慢的过程。当`CPU`被指示去取内存中地址`j`的内容时，会连续发生以下操作：

​			(a)  `j`从`CPU`传到`RAM`;

​			(b)  `RAM`的**直接访问逻辑(direct-access logic)**选中地址为`j`的寄存器;

​			(c)  `RAM[j]`的内容传回到`CPU`;



​		寄存器也能提供同样的数据访问功能， 但没有开会的数据传递和寻址开销。

- 寄存器位于`CPU`内部，所以对它们的访问几乎可以瞬间完成

- 与数百万个内存单元相比，寄存器数量非常少，机器语言指令可以使用短短几个位就能指定要操作的寄存器在什么位置，指令格式也会更短。

  ​	

  不同的目的，不同的`CPU`采用不同数量、不同类型的寄存器。

- **数据寄存器(Data registers)**		为`CPU`提供短期记忆(memory)服务。例如计算`(a+b)*c`，必须先计算`(a+b)`的值并储存，可以暂存`(a+b)`到数据寄存器。

- **寻址寄存器(Addressing registers)**   为了进行读写，`CPU`必须连续访问内存中的数据。这样我们必须确定被访问的**内存字(word)**所在的内存地址。由上条指令得出的地址，地址会被存储在**寻址寄存器**。

- **程序计数寄存器(Program counter register)**  执行程序时，`CPU`必须总是知道下一条指令在指令内存中的地址，地址保存在**程序计数寄存器(PC, Program Counter)**中。`CPU`通过两种方式更新`PC`的内容：

  - 如果当前指令存在需要执行的`goto n`命令，则`CPU`将`PC`置为`n`；
  - 否则，`PC`增1以便指针指向程序中的下一条指令。



#### 6.输入输出

​		计算机使用一组**输入输出(I/O)设备**来与其外部环境进行交互。**不考虑**设备本身的构造，每个设备代表一块独立的机器，需要相关的工程知识；CSer设计不同方案将不同外设的**物理细节封装**，让计算机以相同的方式对它们进行操作，其中最简单的实现技巧之一就是**I/O映像(memory-mapped I/O)**。

​		I/O映像的基本思想是：创建I/O设备的二进制仿真，使其对于`CPU`而言，“看上去”就像普通的内存段。



### Hack 硬件平台规范详述

#### 1.概述

​		Hack平台是16-位冯·诺伊曼机，一个`CPU`、两个独立的内存模块（指令内存和数据内存）和两个内存映像I/O设备（屏幕和键盘）。

​		Hack计算机执行位于指令内存中的程序。指令内存是只读设备，可以用ROM芯片实现。加载新的程序意味着要替换整个ROM芯片。HACK平台的硬件仿真器提供了**加载文本文件**的方法，文本文件包含用**Hack机器语言**编写的程序（从新在开始，**分别用RAM和ROM来指代Hack的数据内存和指令内存**）。因此两个独立的内存模块为：RAM和ROM。

​		Hack的CPU由**ALU**和三个分别称为**数据寄存器(D, data regiter)**、**地址寄存器(A, address register)**、**程序计数器(PC, program counter)**的寄存器组成。

![The Hack Computer](C5-计算机体系结构.assets/image-20200902144121386.png)