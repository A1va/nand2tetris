# [汇编编译器 Assembler]

​		我们已经完成了计算机的**硬件平台(hardware platform)**，此后我们将集中探讨计算机的**软件阶层体系(software hierarchy)**，直到最后为简单的面向对象编程语言开发**编译器**和**基本的操作系统**为止。

​		在软件阶层体系中，最基本的模块就是**汇编编译器(assembler)**。在C4中介绍了机器语言的两种表达形式，即**汇编形式**和**二进制形式**。在这里我们将了解编译器如何系统地将汇编语言编写的程序**翻译**成二进制形式。

​		因为符号化汇编命令(symbolic assembler commands)与其对应的二进制代码之间的关系很简单，唯一的复杂性在于：**允许汇编程序使用符号来指代内存地址**。我们希望通过编译器来管理这些**用户自定义的符号(symbols)**，将它们解析成物理内存地址。一般使用**符号表(symbol table)**来完成这个任务，这种符号表是经典的数据结构，应用在很多软件编译过程中。



### [背景知识]

#### 1. 符号(Symbols)

​		符号在汇编程序通常有两个用途：

- **变量(Variables)**：**程序员可以使用符号的变量名称，翻译器会“自动地”为其分配内存地址**。这些地址的实际值是没有意义的，只要在程序的整个编译过程中，**每个符号始终被指代为同一内存地址**即可。

- **标签(Labels)**：**程序员可以在程序中用符号来标注不同的位置**。比如，可以用标签`loop`来指代特定代码段的起始位置。程序中的其它指令就可以有条件或无条件地执行`goto loop`指令。

  ​		用户定义的**变量名称**和**符号标签(symbolic labels)**，与实际内存地址的映射则不是这么简单。确定符号地址的任务是从用硬件层级上升到软件层级过程中遇到的第一个挑战。

- **符号解析(Sybol Resolution)**：如下图，该程序包含4个用户自定义的符号：2个变量名称(**i**和**sum**)；2个标签(**loop**和**end**)。***如何系统的将符号转换为不含符号的代码呢？***制定两个任意性的**规则**：

  1. **翻译后的代码**将被存储到计算机中**起始地址为0的内存**中；

  2. **变量**将会被分配到**起始地址为1024的内存**中（这些规则依赖于特定的目标硬件平台）。

  - 数据结构处理方式：构建一个符号表(symbol table). 在源代码中，每遇到一个新符号***xxx***，就在符号表中添加一行**(*xxx***, ***n*)**。n是分配给对应符号的内存地址。符号表建立完成后，利用他来将程序翻译成无符号的版本。

![符号解析](C6-汇编编译器.assets/image-20200905143509717.png)

​	如上，符号表的各项键值对 对应了源代码中的自定义符号。只是最后一句需要解释一下，代表了无限循环`end:  goto end`.

​	其中，有3个要点需要说明。

1. 我们定义的变量分配的规则决定了能运行的程序**最多**只能有1024条指令。为了不使实际程序（如操作系统）**溢出**到符号表，存储变量的基地址应该**更远**一些。**(base address>>1024)**
2. **“每条源代码命令映射到一个字(word)”**的假设过于天真。一般情况下，某些汇编指令(`if i = 101 goto end `)会被翻译成几条机器指令，因此每条源代码会占据好几个内存单元。为了解决此问题，翻译程序会记录每条源代码产生的字的个数，然后相应的更新它的**“指令内存计数器(Insvachion memory counter)”**.
3. 对于**“每个变量用一个单一的内存单元来表示”**的假设可能也不实际。编程语言支持**多种类型的变量**，各自占用着**不同的内存空间**。因此，当为变量分配内存空间时，翻译程序必须考虑他们的**数据类型**和**硬件内存单元的宽度**。



#### 2.汇编编译器(Assembler)

​		汇编编译器将汇编程序翻译成计算机的二进制机器语言，才能被计算机执行。生成的代码被加载到计算机的内存中然后被硬件执行。

​		可见，汇编编译器实际上主要是个文本处理程序，设计目的是提供翻译服务。因此我们要有完整的汇编语法说明文档和相应的二进制代码。有了这样的约定（通常称为机器语言规范），让每个符号命令执行下面的任务：

- 解析出符号命令内在的**域**。（解析）

- 对于每个域，**产生**机器语言中相应的**位域**。（代码生成）

- 用内存单元的**数字地址**来**替换**所有的**符号引用**。（符号处理）

- 将二进制码**汇编**成完整的机器指令。（汇编）

  其中三个任务（解析、代码生成和汇编）是相当容易实现的。而符号处理则相对复杂，是汇编编译器的主要功能。(——符号表)



### [Hack 汇编到二进制的翻译规范详述]

#### 1. 语法规约和文件格式

**文件名称**		习惯上，二进制机器码程序后缀名为“Hack”，汇编代码程序的后缀名为“asm”。因此，Prog.asm文件会被汇编翻译器翻译成Prog.hack文件。



















#### 4.范例

汇编代码(Prog.asm):

```assembly
// Adds 1 + ... + 100
	@i
	M=1
    @sum
    M=0
(LOOP)
	@i
	D=M
	@100
	D=D-A
	@END
	D;JGT
	@i
	D=M
	@sum
	M=D+M
	@i
	M=M+1
	@LOOP
	0;JMP
(END)
	@END
	0;JMP  // infinite loop
```

被翻译成二进制码……

